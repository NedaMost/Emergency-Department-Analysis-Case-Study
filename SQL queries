-- Q1
WITH MH_VISITS_DAILY AS
(
    SELECT CAST([ArrivalDateTime] AS DATE) AS VISIT_DATE, COUNT(*) AS VISIT_FREQ
    FROM [NEDA].[dbo].[HOSPITAL_A]
    GROUP BY CAST([ArrivalDateTime] AS DATE)
)
SELECT ROUND(AVG(CAST(VISIT_FREQ AS FLOAT)), 2) AS AVG_DAILY_VISIT
FROM MH_VISITS_DAILY;

--Q2
SELECT [AcuityLevel], COUNT(DISTINCT [PatientID]) AS UNIQUE_PATIENT
 FROM [NEDA].[dbo].[HOSPITAL_A]
 GROUP BY [AcuityLevel]
 ORDER BY COUNT(DISTINCT [PatientID]) DESC

--Q3
 SELECT top (3)[PresentingComplaint], COUNT(*) AS FREQ
 FROM [NEDA].[dbo].[HOSPITAL_A]
 GROUP BY [PresentingComplaint]
ORDER BY COUNT(*) DESC

--Q4
WITH STAY_LEN AS 
(
    SELECT CAST(DATEDIFF(MINUTE, [ArrivalDateTime], [DateTimeLeftEmergency]) AS FLOAT) AS STAY_LEN_MM
    FROM  [NEDA].[dbo].[HOSPITAL_A]
)

SELECT  ROUND(CAST(AVG(STAY_LEN_MM) / 60 AS FLOAT),2) AS STAY_HH_AVG,
        ROUND(CAST(AVG(STAY_LEN_MM) AS FLOAT),2) AS STAY_MM_AVG,
		ROUND((MAX(STAY_LEN_MM) - MIN(STAY_LEN_MM))/60,2) AS RANGE_STAY_LEN_HH
FROM 
    STAY_LEN;

--Q5
SELECT DATENAME(WEEKDAY, [ArrivalDateTime]) AS WEEKDAY, COUNT(*) AS FREQ
FROM [NEDA].[dbo].[HOSPITAL_A]
GROUP BY DATENAME(WEEKDAY, [ArrivalDateTime])
ORDER BY COUNT(*) DESC

---Median
WITH STAY_LEN AS 
(
    SELECT CAST(DATEDIFF(MINUTE, [ArrivalDateTime], [DateTimeLeftEmergency]) AS FLOAT) AS STAY_LEN_MM
    FROM  [NEDA].[dbo].[HOSPITAL_A]
)
SELECT MAX(STAY_LEN_MM / 60) AS MEDIAN
FROM
(
SELECT STAY_LEN_MM,
 NTILE (4) OVER (ORDER BY STAY_LEN_MM) AS QUARTILE
 FROM STAY_LEN
 ) A
 WHERE QUARTILE = 2


--Q6
WITH INITIAL_VISIT AS (
    SELECT [PatientID], MIN([ArrivalDateTime]) AS FIRST_VISIT_TIME
    FROM [NEDA].[dbo].[HOSPITAL_A]
    GROUP BY [PatientID]
),
HB_VISIT AS (
    SELECT DISTINCT A.[PatientID]
    FROM INITIAL_VISIT A
    JOIN [NEDA].[dbo].[HOSPITAL_B] B
      ON A.[PatientID] = B.[PatientID]
     AND B.[ArrivalDateTime] BETWEEN A.FIRST_VISIT_TIME AND DATEADD(HOUR, 24, A.FIRST_VISIT_TIME)
)
SELECT COUNT(DISTINCT [PatientID]) AS UNI_PATIENT
FROM HB_VISIT;

--Q7

SELECT * 
INTO HOSPITAL_AB
FROM [NEDA].[dbo].[HOSPITAL_A]
UNION ALL 
SELECT * FROM [NEDA].[dbo].[HOSPITAL_B]

SELECT COUNT(DISTINCT([PatientID])) AS UNI_PATIENT
FROM HOSPITAL_AB
WHERE DATEPART(HOUR, [ArrivalDateTime]) BETWEEN 8 AND 16


SELECT *
FROM HOSPITAL_AB
WHERE (CAST([ArrivalDateTime] AS DATE) BETWEEN '2021-09-01' AND '2021-10-15')
    OR 
    (CAST([ArrivalDateTime] AS DATE) BETWEEN '2022-02-01' AND '2022-03-31');


	SELECT * FROM [NEDA].[dbo].[HOSPITAL_AB] WHERE [VisitID] LIKE 'F%';
